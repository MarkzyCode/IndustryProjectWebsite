# Import the necessary libraries
import pyodbc
import pandas as pd

# Connect to the Azure SQL Database
def connect_to_azure_sql_database():
  server = 'industry-project-database-sever.database.windows.net'
  database = 'Industry-Project-Database'
  username = 'TeamAdmin'
  password = 'P@ssw0rd'   
  driver= '{ODBC Driver 18 for SQL Server}'
  
  connection_string = 'Driver='+driver+';Server=tcp:'+server+',1433;Database='+database+';Uid='+username+';PWD='+password+';Encrypt=yes;TrustServerCertificate=no;Connection Timeout=30;'
  connection = pyodbc.connect(connection_string)
  return connection

# Read the Excel file
def read_excel_file(file_path, sheet_name):
    try:
        # Drop rows with missing essential columns + ensures correct data types
        df = pd.read_excel(file_path, sheet_name=sheet_name)
        df = df.dropna(subset=['image_id', 'turtle_id'])
        df = df.astype({'image_id': 'str', 'turtle_id': 'str'})
        return df 
    except Exception as e:
        print(f"Error reading Excel file: {e}")
        return None

def insert_s_turtleID(df, connection):
    insert_sql_secondaryTurtle = """INSERT INTO Turtle (secondaryTurtleID) VALUES (?);"""
    get_last_identityID = """SELECT SCOPE_IDENTITY();"""

    # Iterate over the DataFrame and insert values into the Turtle table
    turtle_ids = []
    try:
        with connection.cursor() as cursor:
            for i, row in df.itertuples(index=False):
                cursor.execute(insert_sql_secondaryTurtle, row['turtle_id'])
                cursor.execute(get_last_identityID) 
                current_turtle_id = cursor.fetchone()[0]
                turtle_ids.append(current_turtle_id)
        connection.commit()
    except pyodbc.Error as e:
        print(f"Error inserting into Turtle table: {e}")
        connection.rollback()

    # Return IDENTITY turtleID values to be used as a parameter for 'insert_s_imageID' function
    return turtle_ids  


def insert_s_imageID(df, turtle_ids, connection):
    insert_sql_secondaryImage = """INSERT INTO Image (turtleID, secondaryImageID) VALUES (?, ?);"""

    # Insert excel imageID and their respective turtleID into the Image table
    try:
        with connection.cursor() as cursor:
            for i, row in df.iterrows():
                cursor.execute(insert_sql_secondaryImage, turtle_ids[i], row['image_id'])
        connection.commit() 
    except pyodbc.Error as e:
        print(f"Error inserting into Image table: {e}")
        connection.rollback()

def main():
    file_path = r"C:\Users\Patst\OneDrive\Documents\[1] University 2.0\2024 Sem 2\ICT342\excelScraping\extra_images.xlsx"
    sheet_name = 'extra_images'

    try:
        connection = connect_to_azure_sql_database()

        # Read the Excel file
        df = read_excel_file(file_path, sheet_name=sheet_name)
        if df is not None:
            turtle_ids = insert_s_turtleID(df, connection)
            insert_s_imageID(df, turtle_ids, connection)

            # Display the DataFrame
            connection.commit()
            print(df)
    except Exception as e:
        print(f"Error: {e}")
    finally:
        connection.close()

if __name__ == "__main__":
    main()    

# TO DO
# 1. CHANGE FILE PATH TO CORRECT FILE PATH OF EXCEL FILE (LINE 65)
# 2. CHECK SHEET NAME AND COLUMN HEADERS ARE CORRECT (LINE 22, 23, 38, 58)
# 3. RUN THE SCRIPT